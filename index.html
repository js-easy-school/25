<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–æ–Ω–¥-–°–∫—Ä–∏–Ω–µ—Ä: –¢–û–õ–¨–ö–û –§–ò–ö–° 23%+</title>
    <style>
        :root {
            --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; 
            --accent: #d500f9; --green: #00e676; --red: #ff1744;
            --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        h1 { border-bottom: 2px solid var(--accent); padding-bottom: 10px; color: var(--accent); }
        
        button {
            background: var(--accent); color: white; border: none; padding: 12px 24px; 
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; margin-bottom: 20px;
        }
        button:hover { opacity: 0.9; }

        .filters { display: flex; gap: 20px; background: var(--panel); padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: center;}
        input[type="number"] { background: #333; border: 1px solid #555; color: white; padding: 8px; width: 80px; border-radius: 4px; }
        
        .tables-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .tables-grid { grid-template-columns: 1fr; } }
        
        .card { background: var(--panel); border-radius: 8px; padding: 0; overflow: hidden; border: 1px solid var(--border); }
        .card-header { padding: 15px; background: #252525; font-weight: bold; border-bottom: 1px solid var(--border); }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #2a2a2a; color: #aaa; padding: 10px; text-align: left; font-size: 12px; }
        td { padding: 8px 10px; border-bottom: 1px solid #333; }
        tr:hover { background: #2d2d2d; }
        
        .yield-high { color: var(--green); font-weight: bold; }
        .nkd-warn { color: var(--red); font-weight: bold; }
        
        .rating-badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: #000; font-weight: bold; }
        .r-A { background: #b9f6ca; } /* A- to A+ */
        .r-B { background: #ffff8d; } /* BB+ and below */

        .sell-block { background: rgba(255, 23, 68, 0.1); border: 1px solid var(--red); padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        .sell-title { color: var(--red); font-weight: bold; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üíé –¢–û–õ–¨–ö–û –§–ò–ö–°–´: 23% –ò –í–´–®–ï</h1>
        <div style="display:flex; gap:10px; align-items:center;">
             <span id="status" style="color:#888;">–ù–∞–∂–º–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å -></span>
            <button onclick="updateData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã MOEX</button>
        </div>
    </div>

    <div class="sell-block">
        <span class="sell-title">üîª –ò–°–¢–û–ß–ù–ò–ö–ò –°–†–ï–î–°–¢–í (–ü–†–û–î–ê–¢–¨):</span>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <b>–°—á–µ—Ç 400KKYN:</b><br>
                1. –ì–¢–õ–ö 2–†-04, 2–†-07 (–¶–µ–Ω–∞ >103%)<br>
                2. –°–±–µ—Ä–±–∞–Ω–∫, –ê—ç—Ä–æ—Ñ–ª–æ—Ç, –ö–ê–ú–ê–ó (–ù–∏–∑–∫–∏–π –∫—É–ø–æ–Ω)<br>
                3. –î–û–ú.–†–§, –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ (–î–æ—Ö–æ–¥ < 18%)
            </div>
            <div>
                <b>–°—á–µ—Ç S00KKYN (–ò–ò–°):</b><br>
                1. –ú–¢–°, –ú–µ–≥–∞—Ñ–æ–Ω, –†–æ—Å—Ç–µ–ª–µ–∫–æ–º (–°—Ç–∞—Ä—ã–µ –≤—ã–ø—É—Å–∫–∏)<br>
                2. –†—É—Å–ì–∏–¥—Ä–æ, –†–æ—Å—Å–µ—Ç–∏, –ú–∞–≥–Ω–∏—Ç<br>
                3. –°–±–µ—Ä–±–∞–Ω–∫ –æ–±–ª–∏–≥–∞—Ü–∏–∏
            </div>
        </div>
    </div>

    <div class="filters">
        <label>–ö–æ–ª-–≤–æ –±—É–º–∞–≥: <input type="number" id="qty" value="4" onchange="render()"></label>
        <label>–ú–∞–∫—Å –ù–ö–î (—Ä—É–±): <input type="number" id="nkdMax" value="60" onchange="render()"></label>
    </div>

    <div class="tables-grid">
        <div class="card">
            <div class="card-header">–°—á–µ—Ç 400KKYN (–ë—Ä–æ–∫–µ—Ä—Å–∫–∏–π)</div>
            <div style="overflow-x:auto;">
                <table id="t400">
                    <thead>
                        <tr>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ / ISIN</th>
                            <th>–ö—É–ø–æ–Ω %</th>
                            <th>–î–æ—Ö %</th>
                            <th>–ù–ö–î</th>
                            <th>–°—É–º–º–∞ (‚ÇΩ)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="padding:10px; text-align:right; font-weight:bold; color:#888;" id="sum400">–ò—Ç–æ–≥–æ: 0 ‚ÇΩ</div>
        </div>

        <div class="card">
            <div class="card-header">–°—á–µ—Ç S00KKYN (–ò–ò–°)</div>
            <div style="overflow-x:auto;">
                <table id="tS00">
                    <thead>
                        <tr>
                            <th>–†–µ–π—Ç–∏–Ω–≥</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ / ISIN</th>
                            <th>–ö—É–ø–æ–Ω %</th>
                            <th>–î–æ—Ö %</th>
                            <th>–ù–ö–î</th>
                            <th>–°—É–º–º–∞ (‚ÇΩ)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div style="padding:10px; text-align:right; font-weight:bold; color:#888;" id="sumS00">–ò—Ç–æ–≥–æ: 0 ‚ÇΩ</div>
        </div>
    </div>
</div>

<script>
    // –°–ø–∏—Å–æ–∫ –æ–±–ª–∏–≥–∞—Ü–∏–π –¢–û–õ–¨–ö–û –° –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ú –ö–£–ü–û–ù–û–ú ~23-27%
    // –í–∫–ª—é—á–∞—è High Yield (A-, BBB, BB+)
    const bondsDB = [
        {i:"RU000A1082K7", r:"A-", n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 002–†-01"}, // –ö—É–ø–æ–Ω ~25% (–æ—Ñ–µ—Ä—Ç–∞)
        {i:"RU000A108D81", r:"A-", n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 001–†-05"},
        {i:"RU000A10A141", r:"A-", n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 002–†-02"}, // –°–≤–µ–∂–∏–π
        {i:"RU000A1095L7", r:"A",  n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü16"},    // –û—Ñ–µ—Ä—Ç–∞ —Å –≤—ã—Å–æ–∫–∏–º –∫—É–ø–æ–Ω–æ–º
        {i:"RU000A109874", r:"A",  n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü18"},
        {i:"RU000A106SK2", r:"A-", n:"–ê–ü–†–ò –§–ª–∞–π –ü–ª—ç–Ω–∏–Ω–≥ 2–†2"},
        {i:"RU000A1082X0", r:"A",  n:"–°—ç—Ç–ª –ì—Ä—É–ø–ø 002P-03"}, // ~20-22% YTM
        {i:"RU000A105XF4", r:"A-", n:"–ì–ª–æ—Ä–∞–∫—Å 001–†-01"},
        {i:"RU000A1084E6", r:"A-", n:"–ë—Ä—É—Å–Ω–∏–∫–∞ 002–†-02"},
        {i:"RU000A1082Y8", r:"A-", n:"–î–∂–∏-–ì—Ä—É–ø–ø 002–†-03"},
        
        // –í–î–û –∏ –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ (–¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 23%+)
        {i:"RU000A109098", r:"BB+", n:"–ê–π–î–∏ –ö–æ–ª–ª–µ–∫—Ç 001P-06"}, // –ö—É–ø–æ–Ω ~24-26%
        {i:"RU000A108U72", r:"A-",  n:"–ü–ö–ë 001–†-05"},
        {i:"RU000A107D33", r:"A-",  n:"–°–∏–±–ê–≤—Ç–æ–¢—Ä–∞–Ω—Å 001–†-03"},
        {i:"RU000A1089L4", r:"BB+", n:"–ó–∞–π–º–µ—Ä 001P-02"},
        {i:"RU000A107C91", r:"BB+", n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 002–†-04"},
        {i:"RU000A107SA1", r:"BB+", n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 002–†-05"},
        {i:"RU000A108L81", r:"BB+", n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 002–†-06"},
        {i:"RU000A109L98", r:"B+",  n:"–ù–∏–∫–∞ 001P-04"}, // –†–∏—Å–∫, –Ω–æ –∫—É–ø–æ–Ω –≤—ã—Å–æ–∫–∏–π
        {i:"RU000A109KV2", r:"AA+", n:"–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ 001–†-14"}, // –°–≤–µ–∂–∏–π —Ñ–∏–∫—Å
        {i:"RU000A1092M5", r:"A",   n:"–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥ 001–†-09"},
        {i:"RU000A107C34", r:"A",   n:"–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥ 001–†-07"},
        {i:"RU000A108JH3", r:"A",   n:"–≠–ª–µ–º–µ–Ω—Ç –õ–∏–∑–∏–Ω–≥ 1–†-08"},
        {i:"RU000A1071U9", r:"BB+", n:"–ö–∞—Ä–ú–∞–Ω–∏ 002P-01"},
        {i:"RU000A1080Z9", r:"A",   n:"–Ø–¢–≠–ö 001P-03"},
        {i:"RU000A1099A2", r:"A",   n:"–í–ò–° –§–∏–Ω–∞–Ω—Å –ë–û-–ü06"},
        {i:"RU000A1082W2", r:"A",   n:"–ì—Ä—É–ø–ø–∞ –ê—Å—Ç—Ä–∞ 001P-01"},
        {i:"RU000A109B33", r:"A+",  n:"–î–µ–ª–∏–º–æ–±–∏–ª—å 001P-04"},
        {i:"RU000A109791", r:"A-",  n:"–ù–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ 1–†3"},
        {i:"RU000A107W06", r:"BB",  n:"–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞–≤—Ç–æ–¥–æ—Ä"},
        {i:"RU000A107U81", r:"BB+", n:"–ú–æ–Ω–æ–ø–æ–ª–∏—è 001P-01"},
        {i:"RU000A109V66", r:"BB+", n:"–ê—Ä–µ–Ω–∑–∞-–ü–†–û 001P-05"},
        {i:"RU000A109X29", r:"BB+", n:"–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ –ë–∞–Ω–∫ 1–†1"},
        {i:"RU000A10A3C4", r:"A-",  n:"–ì–ª–æ–±–∞–ª –§–∞–∫—Ç–æ—Ä–∏–Ω–≥"},
        {i:"RU000A1090N4", r:"A+",  n:"–†—É—Å–∞–ª –ë–û-001–†-09"},
        {i:"RU000A108L73", r:"AA",  n:"–°–æ–≤–∫–æ–º–±–∞–Ω–∫ –ë–û-–ü05"}, // –ï—Å–ª–∏ —Ñ–∏–∫—Å –≤—ã–ø—É—Å–∫
        {i:"RU000A1074E7", r:"AA+", n:"–ò–ö–° 5 –§–∏–Ω–∞–Ω—Å 003P-02"},
        {i:"RU000A109S83", r:"AA",  n:"–•—ç–¥—Ö–∞–Ω—Ç–µ—Ä 001–†-01"},
        {i:"RU000A109K40", r:"AA",  n:"–ì—Ä—É–ø–ø–∞ –ü–æ–∑–∏—Ç–∏–≤ 001P-04"},
        {i:"RU000A108AC3", r:"A",   n:"–°–æ–ª–ª–µ—Ä—Å 001P-02"},
        {i:"RU000A107QM0", r:"A-",  n:"–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã 001P-01"},
        {i:"RU000A108462", r:"AAA", n:"–ì–∞–∑–ø—Ä–æ–º –ö–∞–ø–∏—Ç–∞–ª –ë–û-003–†-01"},
        {i:"RU000A1070X5", r:"AAA", n:"–í–≠–ë.–†–§ –ü–ë–û-002–†-37"},
        {i:"RU000A1068R1", r:"AA",  n:"–ß–µ—Ä–∫–∏–∑–æ–≤–æ –ë–û-001–†-06"},
        {i:"RU000A106K43", r:"AAA", n:"–†–æ—Å—Å–µ—Ç–∏ 001P-10R"},
        {i:"RU000A106540", r:"A",   n:"–ú.–í–∏–¥–µ–æ 001–†-04"}
    ];

    let marketData = [];

    async function updateData() {
        const btn = document.querySelector('button');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
        
        marketData = [];
        
        // Batch loading
        for (let i = 0; i < bondsDB.length; i += 5) {
            const batch = bondsDB.slice(i, i + 5);
            await Promise.all(batch.map(fetchOne));
        }

        render();
        btn.disabled = false;
        status.innerText = "–ì–æ—Ç–æ–≤–æ!";
    }

    async function fetchOne(bond) {
        try {
            const url = `https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities/${bond.i}.json`;
            const res = await fetch(url);
            const data = await res.json();
            
            if(!data.securities.data.length) return;

            const sec = data.securities;
            const mkt = data.marketdata;
            const getVal = (src, col) => src.data[0][src.columns.indexOf(col)];

            const priceP = getVal(mkt, 'LAST') || getVal(mkt, 'LCURRENTPRICE');
            if(!priceP) return; // –ù–µ—Ç —Ç–æ—Ä–≥–æ–≤

            const nominal = 1000;
            const nkd = getVal(sec, 'ACCRUEDINT') || 0;
            const couponVal = getVal(sec, 'COUPONVALUE') || 0;
            const period = getVal(sec, 'COUPONPERIOD') || 91;
            
            // –†–∞—Å—á–µ—Ç—ã
            const freq = Math.round(365 / period);
            const couponPercent = (couponVal * freq) / nominal * 100; // –ù–æ–º–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –∫—É–ø–æ–Ω–∞
            
            const priceRub = nominal * (priceP / 100);
            const fullPrice = priceRub + nkd;
            
            // –¢–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (Current Yield) = –ì–æ–¥–æ–≤–æ–π –∫—É–ø–æ–Ω / –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏
            const currentYield = (couponVal * freq) / fullPrice * 100;

            marketData.push({
                ...bond,
                priceRub, fullPrice, nkd, 
                couponPercent, currentYield
            });

        } catch (e) { console.error(e); }
    }

    function render() {
        const qty = document.getElementById('qty').value;
        const nkdMax = document.getElementById('nkdMax').value;
        const tbody400 = document.querySelector('#t400 tbody');
        const tbodyS00 = document.querySelector('#tS00 tbody');
        
        tbody400.innerHTML = '';
        tbodyS00.innerHTML = '';

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ —Å–∞–º–∞—è –≤—ã—Å–æ–∫–∞—è —Ç–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
        marketData.sort((a, b) => b.currentYield - a.currentYield);

        let totalSum = 0;
        let html = '';

        marketData.forEach(d => {
            // –§–ò–õ–¨–¢–†: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å > 22% (—Å –∑–∞–ø–∞—Å–æ–º) –∏ –ù–ö–î –≤ –Ω–æ—Ä–º–µ
            if (d.currentYield < 22) return;

            const cost = d.fullPrice * qty;
            const nkdClass = d.nkd > nkdMax ? 'nkd-warn' : '';
            const rClass = ['A-', 'A', 'A+', 'AA', 'AAA'].some(r => d.r.includes(r)) ? 'r-A' : 'r-B';
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã—Å–æ–∫–∏–π –ù–ö–î –∏–∑ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–∏–º)
            
            html += `
            <tr>
                <td><span class="rating-badge ${rClass}">${d.r}</span></td>
                <td>
                    <b>${d.n}</b><br>
                    <span style="font-size:10px; color:#666;">${d.i}</span>
                </td>
                <td>${d.couponPercent.toFixed(1)}%</td>
                <td class="yield-high">${d.currentYield.toFixed(2)}%</td>
                <td class="${nkdClass}">${d.nkd.toFixed(1)}</td>
                <td>${cost.toLocaleString('ru-RU', {maximumFractionDigits:0})} ‚ÇΩ</td>
            </tr>
            `;
            
            // –î–ª—è —Å—É–º–º—ã —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ
            if(d.nkd <= nkdMax) totalSum += cost;
        });

        tbody400.innerHTML = html;
        tbodyS00.innerHTML = html;
        
        document.getElementById('sum400').innerText = "–ë—é–¥–∂–µ—Ç –Ω–∞ –ø–æ–∫—É–ø–∫—É (–±–µ–∑ '–∫—Ä–∞—Å–Ω—ã—Ö' –ù–ö–î): " + totalSum.toLocaleString() + " ‚ÇΩ";
        document.getElementById('sumS00').innerText = "–ë—é–¥–∂–µ—Ç –Ω–∞ –ø–æ–∫—É–ø–∫—É (–±–µ–∑ '–∫—Ä–∞—Å–Ω—ã—Ö' –ù–ö–î): " + totalSum.toLocaleString() + " ‚ÇΩ";
    }
</script>

</body>
</html>
