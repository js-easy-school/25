<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–Ω—ã–π –°–ø–∏—Å–æ–∫ –û–±–ª–∏–≥–∞—Ü–∏–π (–§–ò–ö–°)</title>
    <style>
        :root {
            --bg: #1a1a1a; --panel: #2d2d2d; --text: #f0f0f0; 
            --accent: #00e676; --warn: #ffab00; --danger: #ff5252;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); padding: 20px; font-size: 13px; }
        .container { max-width: 1600px; margin: 0 auto; }
        
        h1 { color: var(--accent); border-bottom: 2px solid #444; padding-bottom: 10px; }
        
        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .controls { 
            background: var(--panel); padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;
        }
        .c-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; color: #aaa; text-transform: uppercase; }
        input, select { background: #1a1a1a; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; min-width: 100px; }
        
        button {
            background: var(--accent); color: #000; border: none; padding: 10px 20px; 
            border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; height: 36px;
        }
        button:hover { background: #00c853; }
        button:disabled { background: #555; color: #888; cursor: not-allowed; }

        /* –¢–∞–±–ª–∏—Ü—ã */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media(max-width: 1200px) { .grid { grid-template-columns: 1fr; } }
        
        .box { background: var(--panel); border-radius: 8px; overflow: hidden; border: 1px solid #444; }
        .box-header { padding: 12px; background: #333; font-weight: bold; display: flex; justify-content: space-between; }
        .box-body { overflow-x: auto; max-height: 800px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { background: #222; color: #888; padding: 10px; text-align: left; position: sticky; top: 0; }
        td { padding: 8px 10px; border-bottom: 1px solid #3d3d3d; }
        tr:hover { background: #383838; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
        .y-high { color: var(--accent); font-weight: bold; }
        .y-mid { color: var(--warn); }
        .nkd-high { color: var(--danger); font-weight: bold; }
        .r-tag { font-size: 10px; padding: 2px 5px; border-radius: 3px; color: #000; font-weight: bold; display: inline-block; width: 30px; text-align: center; }
        .bg-A { background: #b9f6ca; }
        .bg-B { background: #ffff8d; }
        .bg-C { background: #ff8a80; }

        #progress { width: 0%; height: 3px; background: var(--accent); transition: width 0.3s; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>üíº –ü–û–†–¢–§–ï–õ–¨: –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô –ö–£–ü–û–ù 23%+</h1>
    
    <div id="progress"></div>

    <div class="controls">
        <div class="c-group">
            <label>–°—Ç–∞—Ç—É—Å</label>
            <button id="loadBtn" onclick="startLoading()">üîÑ –ó–ê–ì–†–£–ó–ò–¢–¨ (MOEX)</button>
        </div>
        <div class="c-group">
            <label>–ö–æ–ª-–≤–æ –±—É–º–∞–≥ (—à—Ç)</label>
            <input type="number" id="qty" value="4" onchange="renderTable()">
        </div>
        <div class="c-group">
            <label>–ú–∏–Ω. –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å (%)</label>
            <input type="number" id="minYield" value="20" step="0.5" onchange="renderTable()">
        </div>
        <div class="c-group">
            <label>–ú–∞–∫—Å. –ù–ö–î (—Ä—É–±)</label>
            <input type="number" id="maxNKD" value="60" onchange="renderTable()">
        </div>
    </div>

    <details style="margin-bottom: 20px; background: #3d2c2c; padding: 10px; border-radius: 6px; border: 1px solid #ff5252;">
        <summary style="cursor: pointer; color: #ff5252; font-weight: bold;">üîª –°–ü–ò–°–û–ö –ù–ê –ü–†–û–î–ê–ñ–£ (–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å)</summary>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
            <div>
                <b style="color:#aaa">–°—á–µ—Ç 400KKYN:</b>
                <ul style="margin: 5px 0 0 20px; color: #ddd;">
                    <li>–ì–¢–õ–ö 2–†-04, 2–†-07 (–¶–µ–Ω–∞ >103%)</li>
                    <li>–°–±–µ—Ä–±–∞–Ω–∫, –ê—ç—Ä–æ—Ñ–ª–æ—Ç, –ö–ê–ú–ê–ó (–ù–∏–∑–∫–∏–π –∫—É–ø–æ–Ω)</li>
                    <li>–î–û–ú.–†–§, –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ (–î–æ—Ö–æ–¥ < 18%)</li>
                </ul>
            </div>
            <div>
                <b style="color:#aaa">–°—á–µ—Ç S00KKYN (–ò–ò–°):</b>
                <ul style="margin: 5px 0 0 20px; color: #ddd;">
                    <li>–ú–¢–°, –ú–µ–≥–∞—Ñ–æ–Ω, –†–æ—Å—Ç–µ–ª–µ–∫–æ–º (–°—Ç–∞—Ä—ã–µ –≤—ã–ø—É—Å–∫–∏)</li>
                    <li>–†—É—Å–ì–∏–¥—Ä–æ, –†–æ—Å—Å–µ—Ç–∏, –ú–∞–≥–Ω–∏—Ç</li>
                    <li>–°–±–µ—Ä–±–∞–Ω–∫ –æ–±–ª–∏–≥–∞—Ü–∏–∏</li>
                </ul>
            </div>
        </div>
    </details>

    <div class="grid">
        <div class="box">
            <div class="box-header">
                <span>–°—á–µ—Ç 400KKYN</span>
                <span id="total400" style="color:var(--accent)">0 ‚ÇΩ</span>
            </div>
            <div class="box-body">
                <table id="t400">
                    <thead>
                        <tr>
                            <th>–†–µ–π—Ç</th>
                            <th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                            <th>–¢–µ–∫.–î–æ—Ö</th>
                            <th>–ù–ö–î</th>
                            <th>–¶–µ–Ω–∞ (—à—Ç)</th>
                            <th>–°—É–º–º–∞</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="box">
            <div class="box-header">
                <span>–°—á–µ—Ç S00KKYN (–ò–ò–°)</span>
                <span id="totalS00" style="color:var(--accent)">0 ‚ÇΩ</span>
            </div>
            <div class="box-body">
                <table id="tS00">
                    <thead>
                        <tr>
                            <th>–†–µ–π—Ç</th>
                            <th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th>
                            <th>–¢–µ–∫.–î–æ—Ö</th>
                            <th>–ù–ö–î</th>
                            <th>–¶–µ–Ω–∞ (—à—Ç)</th>
                            <th>–°—É–º–º–∞</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // –†–ê–°–®–ò–†–ï–ù–ù–´–ô –°–ü–ò–°–û–ö (50+ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
    // –í–∫–ª—é—á–∞–µ—Ç A, A-, BBB, BB+ (–≥–¥–µ –µ—Å—Ç—å —Ñ–∏–∫—Å > 23%)
    const bondsList = [
        // –¢–æ–ø –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ (A- –∏ –≤—ã—à–µ)
        {i:"RU000A1082K7", r:"A-", n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 002–†-01"},
        {i:"RU000A108D81", r:"A-", n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 001–†-05"},
        {i:"RU000A10A141", r:"A-", n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 002–†-02"},
        {i:"RU000A1095L7", r:"A",  n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü16"},
        {i:"RU000A109874", r:"A",  n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü18"},
        {i:"RU000A104JQ3", r:"A",  n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü11"},
        {i:"RU000A1082X0", r:"A",  n:"–°—ç—Ç–ª –ì—Ä—É–ø–ø 002P-03"},
        {i:"RU000A105XF4", r:"A-", n:"–ì–ª–æ—Ä–∞–∫—Å 001–†-01"},
        {i:"RU000A1084E6", r:"A-", n:"–ë—Ä—É—Å–Ω–∏–∫–∞ 002–†-02"},
        {i:"RU000A1082Y8", r:"A-", n:"–î–∂–∏-–ì—Ä—É–ø–ø 002–†-03"},
        {i:"RU000A106540", r:"A",  n:"–ú.–í–∏–¥–µ–æ 001–†-04"},
        {i:"RU000A109B33", r:"A+", n:"–î–µ–ª–∏–º–æ–±–∏–ª—å 1–†-04"},
        {i:"RU000A109791", r:"A-", n:"–ù–æ–≤–¢–µ—Ö 1–†3"},
        {i:"RU000A1092M5", r:"A",  n:"–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥ 1–†-09"},
        {i:"RU000A107C34", r:"A",  n:"–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥ 1–†-07"},
        {i:"RU000A108JH3", r:"A",  n:"–≠–ª–µ–º–µ–Ω—Ç –õ–∏–∑ 1–†-08"},
        {i:"RU000A1080Z9", r:"A",  n:"–Ø–¢–≠–ö 001P-03"},
        {i:"RU000A1099A2", r:"A",  n:"–í–ò–° –§–∏–Ω–∞–Ω—Å –ë–û-–ü06"},
        {i:"RU000A1082W2", r:"A",  n:"–ê—Å—Ç—Ä–∞ 001P-01"},
        {i:"RU000A107QM0", r:"A-", n:"–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"},
        {i:"RU000A1090N4", r:"A+", n:"–†—É—Å–∞–ª 1–†-09"},
        {i:"RU000A108AC3", r:"A",  n:"–°–æ–ª–ª–µ—Ä—Å 001P-02"},
        {i:"RU000A106SK2", r:"A-", n:"–ê–ü–†–ò 2–†2"}, 
        {i:"RU000A107D33", r:"A-", n:"–°–∏–±–ê–≤—Ç–æ–¢—Ä–∞–Ω—Å 001–†-03"},
        {i:"RU000A108U72", r:"A-", n:"–ü–ö–ë 001–†-05"},
        
        // –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ (BB+, BBB) - –¥–∞—é—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å 24-27%
        {i:"RU000A109098", r:"BB+", n:"–ê–π–î–∏ –ö–æ–ª–ª–µ–∫—Ç 06"},
        {i:"RU000A107C91", r:"BB+", n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 2–†4"},
        {i:"RU000A107SA1", r:"BB+", n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 2–†5"},
        {i:"RU000A108L81", r:"BB+", n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 2–†6"},
        {i:"RU000A1089L4", r:"BB+", n:"–ó–∞–π–º–µ—Ä 001P-02"},
        {i:"RU000A1071U9", r:"BB+", n:"–ö–∞—Ä–ú–∞–Ω–∏ 002P-01"},
        {i:"RU000A107U81", r:"BB+", n:"–ú–æ–Ω–æ–ø–æ–ª–∏—è 1P-01"},
        {i:"RU000A107W06", r:"BB",  n:"–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞–≤—Ç–æ–¥–æ—Ä"},
        {i:"RU000A109V66", r:"BB+", n:"–ê—Ä–µ–Ω–∑–∞-–ü–†–û 05"},
        {i:"RU000A10A3C4", r:"A-",  n:"–ì–ª–æ–±–∞–ª –§–∞–∫—Ç–æ—Ä–∏–Ω–≥"},
        {i:"RU000A109X29", r:"BB+", n:"–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ –ë–∞–Ω–∫"},
        {i:"RU000A109L98", r:"B+",  n:"–ù–∏–∫–∞ 001P-04"},
        {i:"RU000A108Z85", r:"BB+", n:"–°–∞–º–º–∏—Ç 001P-03"},
        {i:"RU000A1078X8", r:"BB+", n:"–§–µ—Ä—Ä–æ–Ω–∏ –ë–û-01"},
        {i:"RU000A107G63", r:"BB",  n:"–õ–∏–∑–∏–Ω–≥-–¢—Ä–µ–π–¥ 1–†9"},
        {i:"RU000A1083C2", r:"BB",  n:"–õ–∏–∑–∏–Ω–≥-–¢—Ä–µ–π–¥ 1–†11"},
        {i:"RU000A1075E4", r:"BB-", n:"–ü–ò–† 001P-05"},
        {i:"RU000A106PW8", r:"BB",  n:"–ê–π–î–∏ –ö–æ–ª–ª–µ–∫—Ç 05"},
        {i:"RU000A1087G4", r:"BB+", n:"–ö–õ–°-–¢—Ä–µ–π–¥"},
        {i:"RU000A1065Y3", r:"BB+", n:"–í–µ–∫—Ç–æ—Ä –ò–∫—Å"},
        {i:"RU000A1097X4", r:"B+",  n:"–ù–∞—Ñ—Ç–∞—Ç—Ä–∞–Ω—Å 06"},
        {i:"RU000A1089J8", r:"B+",  n:"–ì–¢–ö 001P-03"},
        {i:"RU000A106MV2", r:"B",   n:"–ü–ª–µ–º–∑–∞–≤–æ–¥ 1–†2"},
        {i:"RU000A108103", r:"BB-", n:"–£–ª—å—Ç.–û–Ω–ª–∞–π–Ω 1–†2"},
        {i:"RU000A107R29", r:"BB",  n:"–°–∏–º–ø–ª 001–†-04"},
        {i:"RU000A1080N5", r:"A-",  n:"–°–µ–ª–µ–∫—Ç–µ–ª 1–†4"},
        {i:"RU000A1079G1", r:"BBB", n:"–ì–ö –ï–ö–° 001–†-03"}
    ];

    let loadedData = [];

    async function startLoading() {
        const btn = document.getElementById('loadBtn');
        const bar = document.getElementById('progress');
        btn.disabled = true;
        btn.innerText = "‚è≥ –ó–ê–ì–†–£–ó–ö–ê...";
        loadedData = [];

        const batchSize = 5;
        const total = bondsList.length;

        for (let i = 0; i < total; i += batchSize) {
            const batch = bondsList.slice(i, i + batchSize);
            await Promise.all(batch.map(fetchBond));
            
            // Update UI
            const percent = Math.min(100, ((i + batchSize) / total) * 100);
            bar.style.width = percent + "%";
        }

        renderTable();
        btn.innerText = "‚úÖ –û–ë–ù–û–í–õ–ï–ù–û";
        btn.disabled = false;
        setTimeout(() => { bar.style.width = "0%"; btn.innerText = "üîÑ –û–ë–ù–û–í–ò–¢–¨ (MOEX)"; }, 2000);
    }

    async function fetchBond(bond) {
        try {
            const url = `https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities/${bond.i}.json`;
            const res = await fetch(url);
            const json = await res.json();
            
            if (!json.securities.data.length) return;

            const getVal = (block, name) => block.data[0][block.columns.indexOf(name)];
            const sec = json.securities;
            const mkt = json.marketdata;

            const priceP = getVal(mkt, 'LAST') || getVal(mkt, 'LCURRENTPRICE');
            const nkd = getVal(sec, 'ACCRUEDINT') || 0;
            const coupon = getVal(sec, 'COUPONVALUE') || 0;
            const period = getVal(sec, 'COUPONPERIOD') || 91;
            const nominal = 1000;

            const freq = Math.round(365 / period);
            // –¢–µ–∫—É—â–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å = (–ì–æ–¥–æ–≤–æ–π –∫—É–ø–æ–Ω / –ü–æ–ª–Ω–∞—è —Ü–µ–Ω–∞) * 100
            const fullPrice = (nominal * (priceP || 100) / 100) + nkd;
            const currentYield = fullPrice > 0 ? ((coupon * freq) / fullPrice * 100) : 0;

            loadedData.push({
                ...bond,
                price: priceP || 0,
                nkd: nkd,
                yield: currentYield,
                fullPrice: fullPrice
            });

        } catch (e) {
            console.error(e);
        }
    }

    function renderTable() {
        const qty = parseInt(document.getElementById('qty').value) || 1;
        const minYield = parseFloat(document.getElementById('minYield').value) || 0;
        const maxNKD = parseFloat(document.getElementById('maxNKD').value) || 1000;

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        let displayList = loadedData.filter(d => d.yield >= minYield);
        displayList.sort((a, b) => b.yield - a.yield);

        let html = '';
        let total = 0;

        displayList.forEach(d => {
            const cost = d.fullPrice * qty;
            const isNkdBad = d.nkd > maxNKD;
            
            // –¶–≤–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞
            let rClass = 'bg-B';
            if (d.r.includes('A')) rClass = 'bg-A';
            if (d.r.includes('C')) rClass = 'bg-C';

            // –ï—Å–ª–∏ –ù–ö–î –ø–ª–æ—Ö–æ–π, —Å—Ç—Ä–æ–∫–∞ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è
            const trStyle = isNkdBad ? 'opacity:0.5' : '';

            html += `
            <tr style="${trStyle}">
                <td><span class="r-tag ${rClass}">${d.r}</span></td>
                <td>
                    <b>${d.n}</b><br>
                    <span style="color:#666; font-size:10px;">${d.i}</span>
                </td>
                <td class="${d.yield >= 23 ? 'y-high' : 'y-mid'}">${d.yield.toFixed(2)}%</td>
                <td class="${isNkdBad ? 'nkd-high' : ''}">${d.nkd.toFixed(2)}</td>
                <td>${d.fullPrice.toFixed(0)}</td>
                <td>${cost.toLocaleString()} ‚ÇΩ</td>
            </tr>
            `;

            if (!isNkdBad) total += cost;
        });

        if (loadedData.length === 0 && document.getElementById('loadBtn').disabled === false) {
            html = '<tr><td colspan="6" style="text-align:center; padding:20px;">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–ê–ì–†–£–ó–ò–¢–¨" –≤—ã—à–µ ‚¨ÜÔ∏è</td></tr>';
        } else if (displayList.length === 0 && loadedData.length > 0) {
            html = '<tr><td colspan="6" style="text-align:center; padding:20px;">–ù–µ—Ç –±—É–º–∞–≥ —Å —Ç–∞–∫–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–∏–∑–∏—Ç—å "–ú–∏–Ω. –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å"</td></tr>';
        }

        document.querySelector('#t400 tbody').innerHTML = html;
        document.querySelector('#tS00 tbody').innerHTML = html;
        
        document.getElementById('total400').innerText = total.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('totalS00').innerText = total.toLocaleString() + ' ‚ÇΩ';
    }
    
    // Auto render empty state
    renderTable();
</script>

</body>
</html>
