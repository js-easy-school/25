<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–ª–Ω—ã–π –°–ø–∏—Å–æ–∫ –û–±–ª–∏–≥–∞—Ü–∏–π (v4.0)</title>
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #e0e0e0; --accent: #00e676; --red: #ff5252; --gray: #424242; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; font-size: 13px; }
        .container { max-width: 1800px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--panel); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        h1 { margin: 0; font-size: 20px; color: var(--accent); }
        .status-bar { font-family: monospace; color: #888; }

        button {
            background: var(--accent); color: #000; border: none; padding: 10px 25px; 
            border-radius: 5px; font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #00c853; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }

        /* Controls */
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; background: #252525; padding: 10px; border-radius: 8px;}
        .c-item { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 10px; color: #aaa; text-transform: uppercase; }
        input { background: #121212; border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; width: 80px; }

        /* Tables */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1200px) { .grid { grid-template-columns: 1fr; } }
        
        .box { background: var(--panel); border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; height: 80vh; }
        .box-head { padding: 10px; background: #2a2a2a; font-weight: bold; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .box-body { overflow-y: auto; flex-grow: 1; }
        
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #222; color: #888; padding: 8px; text-align: left; font-size: 11px; z-index: 10; }
        td { padding: 6px 8px; border-bottom: 1px solid #2a2a2a; font-size: 12px; }
        tr:hover { background: #333; }

        /* Styles */
        .rating { padding: 2px 4px; border-radius: 3px; font-size: 10px; font-weight: bold; color: #000; width: 25px; text-align: center; display: inline-block; }
        .r-A { background: #b9f6ca; } 
        .r-B { background: #ffff8d; }
        .r-C { background: #ff8a80; }

        .yield-good { color: var(--accent); font-weight: bold; }
        .yield-mid { color: #ffab00; }
        .yield-low { color: #757575; }
        
        .nkd-high { color: var(--red); font-weight: bold; }

        .loader { height: 3px; background: var(--accent); width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>üìä BOND SCREENER v4.0 (ALL FIXES)</h1>
            <div class="status-bar" id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞...</div>
        </div>
        <button onclick="loadData()" id="btnLoad">üîÑ –ó–ê–ì–†–£–ó–ò–¢–¨ –í–°–ï</button>
    </div>
    <div class="loader" id="loader"></div>

    <details style="margin-bottom: 15px; background: #2a1a1a; padding: 10px; border-radius: 6px; border: 1px solid #ff5252;">
        <summary style="cursor: pointer; color: #ff5252; font-weight: bold;">üîª –°–ü–ò–°–û–ö –ù–ê –ü–†–û–î–ê–ñ–£ (–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</summary>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px; color: #ddd;">
            <div>
                <b>–°—á–µ—Ç 400KKYN:</b> –ì–¢–õ–ö 2–†-04/07 (>103%), –°–±–µ—Ä–±–∞–Ω–∫, –ê—ç—Ä–æ—Ñ–ª–æ—Ç, –ö–ê–ú–ê–ó, –î–û–ú.–†–§, –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏.
            </div>
            <div>
                <b>–°—á–µ—Ç S00KKYN (–ò–ò–°):</b> –ú–¢–°, –ú–µ–≥–∞—Ñ–æ–Ω, –†–æ—Å—Ç–µ–ª–µ–∫–æ–º, –†—É—Å–ì–∏–¥—Ä–æ, –†–æ—Å—Å–µ—Ç–∏, –ú–∞–≥–Ω–∏—Ç, –°–±–µ—Ä–±–∞–Ω–∫.
            </div>
        </div>
    </details>

    <div class="controls">
        <div class="c-item">
            <label>–ö–æ–ª-–≤–æ —à—Ç.</label>
            <input type="number" id="qty" value="4" onchange="render()">
        </div>
        <div class="c-item">
            <label>–¶–µ–ª—å –î–æ—Ö. (%)</label>
            <input type="number" id="targetY" value="23" onchange="render()">
        </div>
        <div class="c-item">
            <label>–ú–∞–∫—Å –ù–ö–î (‚ÇΩ)</label>
            <input type="number" id="maxNKD" value="60" onchange="render()">
        </div>
    </div>

    <div class="grid">
        <div class="box">
            <div class="box-head">
                <span>–°—á–µ—Ç 400KKYN</span>
                <span id="sum1" style="color:var(--accent)">0 ‚ÇΩ</span>
            </div>
            <div class="box-body">
                <table id="t1">
                    <thead><tr><th>–†</th><th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th><th>–ö—É–ø–æ–Ω</th><th>YLD%</th><th>–ù–ö–î</th><th>–°—É–º–º–∞</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div class="box">
            <div class="box-head">
                <span>–°—á–µ—Ç S00KKYN</span>
                <span id="sum2" style="color:var(--accent)">0 ‚ÇΩ</span>
            </div>
            <div class="box-body">
                <table id="t2">
                    <thead><tr><th>–†</th><th>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</th><th>–ö—É–ø–æ–Ω</th><th>YLD%</th><th>–ù–ö–î</th><th>–°—É–º–º–∞</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // 65 ISINs (FIXED COUPON Focus)
    // A mix of A-grade (EuroTrans, Samolet) and High-Yield BB (MFO, Leasing) to ensure list is populated
    const bondsDB = [
        {i:"RU000A1082K7",r:"A-",n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 2–†1"}, {i:"RU000A108D81",r:"A-",n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 1–†5"},
        {i:"RU000A10A141",r:"A-",n:"–ï–≤—Ä–æ–¢—Ä–∞–Ω—Å 2–†2"}, {i:"RU000A1095L7",r:"A",n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü16"},
        {i:"RU000A109874",r:"A",n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü18"}, {i:"RU000A104JQ3",r:"A",n:"–°–∞–º–æ–ª–µ—Ç –ë–û-–ü11"},
        {i:"RU000A1082X0",r:"A",n:"–°—ç—Ç–ª –ì—Ä—É–ø–ø 2P3"}, {i:"RU000A105XF4",r:"A-",n:"–ì–ª–æ—Ä–∞–∫—Å 1–†1"},
        {i:"RU000A1084E6",r:"A-",n:"–ë—Ä—É—Å–Ω–∏–∫–∞ 2–†2"}, {i:"RU000A1082Y8",r:"A-",n:"–î–∂–∏-–ì—Ä—É–ø–ø 2–†3"},
        {i:"RU000A106540",r:"A",n:"–ú.–í–∏–¥–µ–æ 1–†4"}, {i:"RU000A109B33",r:"A+",n:"–î–µ–ª–∏–º–æ–±–∏–ª—å 1–†4"},
        {i:"RU000A109791",r:"A-",n:"–ù–æ–≤–¢–µ—Ö 1–†3"}, {i:"RU000A1092M5",r:"A",n:"–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥ 1–†9"},
        {i:"RU000A107C34",r:"A",n:"–ò–Ω—Ç–µ—Ä–ª–∏–∑–∏–Ω–≥ 1–†7"}, {i:"RU000A108JH3",r:"A",n:"–≠–ª–µ–º–µ–Ω—Ç –õ–∏–∑ 1–†8"},
        {i:"RU000A1080Z9",r:"A",n:"–Ø–¢–≠–ö 1P3"}, {i:"RU000A1099A2",r:"A",n:"–í–ò–° –§–∏–Ω–∞–Ω—Å –ü06"},
        {i:"RU000A1082W2",r:"A",n:"–ê—Å—Ç—Ä–∞ 1P1"}, {i:"RU000A107QM0",r:"A-",n:"–í—Å–µ–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"},
        {i:"RU000A1090N4",r:"A+",n:"–†—É—Å–∞–ª 1–†9"}, {i:"RU000A108AC3",r:"A",n:"–°–æ–ª–ª–µ—Ä—Å 1P2"},
        {i:"RU000A106SK2",r:"A-",n:"–ê–ü–†–ò 2–†2"}, {i:"RU000A107D33",r:"A-",n:"–°–∏–±–ê–≤—Ç–æ–¢—Ä–∞–Ω—Å 1–†3"},
        {i:"RU000A108U72",r:"A-",n:"–ü–ö–ë 1–†5"}, {i:"RU000A109098",r:"BB+",n:"–ê–π–î–∏ –ö–æ–ª–ª–µ–∫—Ç 06"},
        {i:"RU000A107C91",r:"BB+",n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 2–†4"}, {i:"RU000A107SA1",r:"BB+",n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 2–†5"},
        {i:"RU000A108L81",r:"BB+",n:"–ë—ã—Å—Ç—Ä–æ–¥–µ–Ω—å–≥–∏ 2–†6"}, {i:"RU000A1089L4",r:"BB+",n:"–ó–∞–π–º–µ—Ä 1P2"},
        {i:"RU000A1071U9",r:"BB+",n:"–ö–∞—Ä–ú–∞–Ω–∏ 2P1"}, {i:"RU000A107U81",r:"BB+",n:"–ú–æ–Ω–æ–ø–æ–ª–∏—è 1P1"},
        {i:"RU000A107W06",r:"BB",n:"–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫–∞–≤—Ç–æ–¥–æ—Ä"}, {i:"RU000A109V66",r:"BB+",n:"–ê—Ä–µ–Ω–∑–∞-–ü–†–û 05"},
        {i:"RU000A10A3C4",r:"A-",n:"–ì–ª–æ–±–∞–ª –§–∞–∫—Ç–æ—Ä–∏–Ω–≥"}, {i:"RU000A109X29",r:"BB+",n:"–í–∞–π–ª–¥–±–µ—Ä—Ä–∏–∑ –ë–∞–Ω–∫"},
        {i:"RU000A109L98",r:"B+",n:"–ù–∏–∫–∞ 1P4"}, {i:"RU000A108Z85",r:"BB+",n:"–°–∞–º–º–∏—Ç 1P3"},
        {i:"RU000A1078X8",r:"BB+",n:"–§–µ—Ä—Ä–æ–Ω–∏ –ë–û-01"}, {i:"RU000A107G63",r:"BB",n:"–õ–∏–∑–∏–Ω–≥-–¢—Ä–µ–π–¥ 1–†9"},
        {i:"RU000A1083C2",r:"BB",n:"–õ–∏–∑–∏–Ω–≥-–¢—Ä–µ–π–¥ 1–†11"}, {i:"RU000A1075E4",r:"BB-",n:"–ü–ò–† 1P5"},
        {i:"RU000A106PW8",r:"BB",n:"–ê–π–î–∏ –ö–æ–ª–ª–µ–∫—Ç 05"}, {i:"RU000A1087G4",r:"BB+",n:"–ö–õ–°-–¢—Ä–µ–π–¥"},
        {i:"RU000A1065Y3",r:"BB+",n:"–í–µ–∫—Ç–æ—Ä –ò–∫—Å"}, {i:"RU000A1097X4",r:"B+",n:"–ù–∞—Ñ—Ç–∞—Ç—Ä–∞–Ω—Å 06"},
        {i:"RU000A1089J8",r:"B+",n:"–ì–¢–ö 1P3"}, {i:"RU000A106MV2",r:"B",n:"–ü–ª–µ–º–∑–∞–≤–æ–¥ 1–†2"},
        {i:"RU000A108103",r:"BB-",n:"–£–ª—å—Ç.–û–Ω–ª–∞–π–Ω 1–†2"}, {i:"RU000A107R29",r:"BB",n:"–°–∏–º–ø–ª 1–†4"},
        {i:"RU000A1080N5",r:"A-",n:"–°–µ–ª–µ–∫—Ç–µ–ª 1–†4"}, {i:"RU000A1079G1",r:"BBB",n:"–ì–ö –ï–ö–° 1–†3"},
        {i:"RU000A1030X9",r:"A-",n:"–≠—Ç–∞–ª–æ–Ω –§–∏–Ω 2P1"}, {i:"RU000A1053W3",r:"A-",n:"–ì–ª–æ—Ä–∞–∫—Å 1–†1"},
        {i:"RU000A105C93",r:"A-",n:"–õ–µ–≥–µ–Ω–¥–∞ 2–†1"}, {i:"RU000A1067T9",r:"A-",n:"–û–ö–ï–ô 1–†5"},
        {i:"RU000A108994",r:"A-",n:"–û–ö–ï–ô 1–†6"}, {i:"RU000A103WD6",r:"A-",n:"–ë—Ä—É—Å–Ω–∏–∫–∞ 2–†1"},
        {i:"RU000A105TS5",r:"A+",n:"–î–µ–ª–∏–º–æ–±–∏–ª—å 1–†2"}, {i:"RU000A106A86",r:"A+",n:"–î–µ–ª–∏–º–æ–±–∏–ª—å 1–†3"},
        {i:"RU000A107T27",r:"AA-",n:"–Æ–ì–ö 1P3"}, {i:"RU000A109KV2",r:"AA+",n:"–ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏ 1–†14"},
        {i:"RU000A106HB4",r:"A-",n:"–í–£–® 1P2"}
    ];

    let marketData = [];

    async function loadData() {
        const btn = document.getElementById('btnLoad');
        const loader = document.getElementById('loader');
        const status = document.getElementById('statusText');
        
        btn.disabled = true;
        marketData = [];
        let loaded = 0;
        
        status.innerText = `–ó–∞–≥—Ä—É–∑–∫–∞ 0 –∏–∑ ${bondsDB.length}...`;

        // Batch requests
        const batchSize = 5;
        for (let i = 0; i < bondsDB.length; i += batchSize) {
            const batch = bondsDB.slice(i, i + batchSize);
            await Promise.all(batch.map(fetchOne));
            loaded += batch.length;
            
            // Update UI
            loader.style.width = (loaded / bondsDB.length * 100) + "%";
            status.innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${loaded} –∏–∑ ${bondsDB.length}...`;
        }

        render();
        btn.disabled = false;
        loader.style.width = "0%";
        status.innerText = `–ì–æ—Ç–æ–≤–æ. –ü–æ–∫–∞–∑–∞–Ω–æ ${marketData.length} –±—É–º–∞–≥.`;
    }

    async function fetchOne(bond) {
        try {
            const url = `https://iss.moex.com/iss/engines/stock/markets/bonds/boards/TQCB/securities/${bond.i}.json`;
            const res = await fetch(url);
            const data = await res.json();
            
            if(!data.securities.data.length) return; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –±—É–º–∞–≥–µ

            const get = (src, col) => src.data[0][src.columns.indexOf(col)];
            const sec = data.securities;
            const mkt = data.marketdata;

            // –¶–ï–ù–ê: –ü—Ä–æ–±—É–µ–º LAST, –µ—Å–ª–∏ –Ω–µ—Ç -> CLOSE, –µ—Å–ª–∏ –Ω–µ—Ç -> LCURRENTPRICE, –µ—Å–ª–∏ –Ω–µ—Ç -> 0
            let price = get(mkt, 'LAST');
            if (!price) price = get(mkt, 'OPEN'); 
            if (!price) price = get(mkt, 'LCURRENTPRICE');
            if (!price) price = get(mkt, 'CLOSE'); 
            
            const nkd = get(sec, 'ACCRUEDINT') || 0;
            const couponVal = get(sec, 'COUPONVALUE') || 0;
            const period = get(sec, 'COUPONPERIOD') || 91;
            const nominal = 1000; 

            // –†–∞—Å—á–µ—Ç
            const freq = period > 0 ? Math.round(365 / period) : 0;
            const annualCoup = couponVal * freq;
            
            // –ï—Å–ª–∏ —Ü–µ–Ω—ã –Ω–µ—Ç –≤–æ–æ–±—â–µ, —Å—Ç–∞–≤–∏–º –Ω–æ–º–∏–Ω–∞–ª –¥–ª—è –æ—Ä–∏–µ–Ω—Ç–∏—Ä–∞, –Ω–æ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç "N/A"
            const calcPrice = price ? price : 100; 
            const priceRub = nominal * (calcPrice / 100);
            const fullPrice = priceRub + nkd;
            
            // –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å = (–ö—É–ø–æ–Ω –≤ –≥–æ–¥ / –ü–æ–ª–Ω–∞—è —Ü–µ–Ω–∞) * 100
            let yieldProc = 0;
            if (fullPrice > 0 && price > 0) {
                yieldProc = (annualCoup / fullPrice) * 100;
            }

            marketData.push({
                ...bond,
                p: calcPrice,
                nkd: nkd,
                yld: yieldProc,
                fullPrice: fullPrice,
                hasPrice: price > 0
            });

        } catch (e) { console.error(e); }
    }

    function render() {
        const qty = document.getElementById('qty').value;
        const targetY = parseFloat(document.getElementById('targetY').value);
        const maxNKD = parseFloat(document.getElementById('maxNKD').value);

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –°–Ω–∞—á–∞–ª–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å, –ø–æ—Ç–æ–º —Ä–µ–π—Ç–∏–Ω–≥
        marketData.sort((a, b) => b.yld - a.yld);

        let html = '';
        let totalSum = 0;

        marketData.forEach(d => {
            // –ö–ª–∞—Å—Å—ã —Å—Ç–∏–ª–µ–π
            const rClass = d.r.includes('A') ? 'r-A' : (d.r.includes('B') ? 'r-B' : 'r-C');
            
            let yClass = 'yield-low';
            if (d.yld >= targetY) yClass = 'yield-good';
            else if (d.yld >= targetY - 3) yClass = 'yield-mid';

            const nkdClass = d.nkd > maxNKD ? 'nkd-high' : '';
            
            // –ï—Å–ª–∏ —Ü–µ–Ω—ã –Ω–µ—Ç, –ø–∏—à–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
            const yieldText = d.hasPrice ? d.yld.toFixed(2) + '%' : '<span style="color:#666">–ù–µ—Ç —Ç–æ—Ä–≥–æ–≤</span>';
            
            // –°—á–∏—Ç–∞–µ–º —Å—É–º–º—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ö–î –≤ –Ω–æ—Ä–º–µ –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø—Ä–∏–µ–º–ª–µ–º–∞—è (–¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —Ü–∏—Ñ—Ä—ã)
            const cost = d.fullPrice * qty;
            if (d.hasPrice && d.yld >= targetY - 5 && d.nkd <= maxNKD) {
                totalSum += cost;
            }

            html += `
            <tr>
                <td><span class="rating ${rClass}">${d.r}</span></td>
                <td>
                    <b>${d.n}</b><br>
                    <span style="color:#666; font-size:10px">${d.i}</span>
                </td>
                <td>${(d.yld * d.p / 100 * 10).toFixed(0)} ‚ÇΩ</td> 
                <td class="${yClass}">${yieldText}</td>
                <td class="${nkdClass}">${d.nkd.toFixed(1)}</td>
                <td>${cost.toLocaleString()} ‚ÇΩ</td>
            </tr>
            `;
        });

        if (marketData.length === 0) {
            html = '<tr><td colspan="6" style="text-align:center; padding:20px">–ù–∞–∂–º–∏—Ç–µ –ó–ê–ì–†–£–ó–ò–¢–¨ –í–°–ï</td></tr>';
        }

        document.querySelector('#t1 tbody').innerHTML = html;
        document.querySelector('#t2 tbody').innerHTML = html;
        
        document.getElementById('sum1').innerText = "–ë—é–¥–∂–µ—Ç (—Ç–æ–ª—å–∫–æ –¢–æ–ø): " + totalSum.toLocaleString() + " ‚ÇΩ";
        document.getElementById('sum2').innerText = "–ë—é–¥–∂–µ—Ç (—Ç–æ–ª—å–∫–æ –¢–æ–ø): " + totalSum.toLocaleString() + " ‚ÇΩ";
    }
    
    // Auto start
    // loadData();
</script>

</body>
</html>
