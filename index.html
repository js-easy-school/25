<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Si-3.26 PRO Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #111111;
            --text-main: #ffffff;
            --green: #00ff66;
            --red: #ff3333;
            --blue: #00ccff;
            --gray: #666666;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∫—Ä–æ–ª–ª–∏–ª–æ—Å—å –ª–∏—à–Ω–µ–µ */
        }

        /* --- OLED SAVER MODE --- */
        body.saver-mode > *:not(#saver-overlay) {
            opacity: 0;
            pointer-events: none;
        }
        #saver-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        body.saver-mode #saver-overlay { display: flex; }

        .status-dot {
            width: 12px; height: 12px; border-radius: 50%;
            background: #333;
            box-shadow: 0 0 10px #333;
            transition: background 0.5s;
            margin-bottom: 20px;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è "–¥—ã—Ö–∞–Ω–∏—è" —Ç–æ—á–∫–∏ */
        @keyframes breathe { 0% { opacity: 0.4; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.4; transform: scale(0.9); } }
        .status-dot.active { animation: breathe 3s infinite ease-in-out; }

        /* --- UI COMPONENTS --- */
        .header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px;
        }
        .ticker-name { font-size: 14px; color: var(--gray); font-weight: 700; letter-spacing: 1px; }
        .main-price { font-size: 42px; font-weight: 800; line-height: 1; letter-spacing: -1px; margin: 5px 0; }
        .price-change { font-size: 16px; font-weight: 500; }

        .signal-block {
            background: var(--card-bg);
            border: 1px solid #222;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }
        .signal-action { font-size: 32px; font-weight: 900; margin: 10px 0; letter-spacing: 2px; }
        .signal-text { color: #888; font-size: 13px; min-height: 36px; line-height: 1.4; }

        .chart-wrapper {
            flex-grow: 1;
            background: #080808;
            border-radius: 12px;
            border: 1px solid #222;
            position: relative;
            margin-bottom: 15px;
            min-height: 150px;
        }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn {
            background: #222; color: #fff; border: none; padding: 15px;
            border-radius: 10px; font-weight: 600; cursor: pointer;
            font-size: 14px; text-transform: uppercase;
        }
        .btn:active { background: #333; }
        .btn-oled { background: #1a1a2e; color: #aao; }

        /* SETTINGS */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 1000; padding: 30px; box-sizing: border-box;
        }
        input {
            width: 100%; padding: 15px; background: #222; border: 1px solid #444;
            color: white; border-radius: 8px; margin: 10px 0 20px 0; font-size: 16px; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="saver-overlay" onclick="toggleSaver()">
        <div class="status-dot active" id="saver-dot"></div>
        <div id="saver-price" style="color: #444; font-family: 'Courier New', monospace; font-size: 24px;">---</div>
        <div style="color: #222; font-size: 10px; margin-top: 50px;">TAP TO WAKE</div>
    </div>

    <div class="header">
        <div>
            <div class="ticker-name">Si-3.26 (SiH6)</div>
            <div class="main-price" id="ui-price">---</div>
            <div class="price-change" id="ui-change">0.00%</div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 10px; color: #444;">UPD</div>
            <div id="timer" style="font-size: 20px; font-family: monospace; color: #666;">--</div>
        </div>
    </div>

    <div class="signal-block" id="signal-card">
        <div style="font-size: 10px; opacity: 0.4;">AI SIGNAL</div>
        <div class="signal-action" id="ui-signal">WAIT</div>
        <div class="signal-text" id="ui-reason">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å MOEX...</div>
    </div>

    <div class="chart-wrapper">
        <canvas id="chart"></canvas>
    </div>

    <div class="controls">
        <button class="btn btn-oled" onclick="toggleSaver()">üåô OLED Mode</button>
        <button class="btn" onclick="toggleSettings()">‚öôÔ∏è API Key</button>
    </div>

    <div id="settings-modal">
        <h2 style="margin-bottom: 5px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <p style="color: #666; font-size: 12px; margin-bottom: 20px;">–î–ª—è —Ä–∞–±–æ—Ç—ã AI –Ω—É–∂–µ–Ω –∫–ª—é—á OpenRouter (DeepSeek)</p>
        
        <label style="color: #888; font-size: 12px;">OpenRouter API Key</label>
        <input type="password" id="inp-key" placeholder="sk-or-v1-...">
        
        <button class="btn" style="background: var(--blue); width: 100%; margin-bottom: 10px;" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" style="background: transparent; color: #666;" onclick="toggleSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <audio id="snd-alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

<script>
    // --- CONFIGURATION ---
    const STATE = {
        ticker: 'SiH6', // –ö–æ–¥ —Ñ—å—é—á–µ—Ä—Å–∞ (–ú–∞—Ä—Ç 2026)
        apiKey: localStorage.getItem('trader_key') || '',
        interval: 60000, // 1 –º–∏–Ω—É—Ç–∞
        prices: [],
        lastPrice: 0,
        lastSignal: 'WAIT'
    };

    // --- CHART SETUP ---
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#00ccff',
                backgroundColor: 'rgba(0, 204, 255, 0.05)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { position: 'right', grid: { color: '#1a1a1a' } }
            },
            animation: false
        }
    });

    // --- CORE LOGIC (MOEX DIRECT) ---
    async function tick() {
        startTimer();

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä—è–º–æ–π URL –∫ API MOEX (–±–µ–∑ –ø—Ä–æ–∫—Å–∏)
        // iss.meta=off - —É–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä
        // iss.only=marketdata - –±–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        // columns=LAST,LASTCHANGEPRCNT - —Ç–æ–ª—å–∫–æ —Ü–µ–Ω–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
        const url = `https://iss.moex.com/iss/engines/futures/markets/forts/boards/RFUD/securities/${STATE.ticker}.json?iss.meta=off&iss.only=marketdata&marketdata.columns=LAST,LASTCHANGEPRCNT&_=${Date.now()}`;

        try {
            const response = await fetch(url);
            
            if (!response.ok) throw new Error('Network error');
            const json = await response.json();

            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            if (!json.marketdata || !json.marketdata.data || json.marketdata.data.length === 0) {
                console.warn("–†—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç –∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö");
                return;
            }

            const data = json.marketdata.data[0];
            const price = Number(data[0]); // –¶–µ–Ω–∞ LAST
            const change = Number(data[1]); // –ò–∑–º–µ–Ω–µ–Ω–∏–µ %

            if (!price) return;

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI(price, change);
            updateChart(price);

            // –ï—Å–ª–∏ —Ü–µ–Ω–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
            if (price !== STATE.lastPrice) {
                STATE.lastPrice = price;
                
                if (STATE.apiKey) {
                    askAI(price, change);
                } else {
                    simpleAlgo(price, change);
                }
            } else {
                // –ï—Å–ª–∏ —Ü–µ–Ω–∞ —Å—Ç–æ–∏—Ç –Ω–∞ –º–µ—Å—Ç–µ (–≤–µ—á–µ—Ä/–≤—ã—Ö–æ–¥–Ω–æ–π), –ø–∏—à–µ–º —Å—Ç–∞—Ç—É—Å
                document.getElementById('ui-reason').innerText = "–†—ã–Ω–æ–∫ —Å–ø–æ–∫–æ–µ–Ω (—Ü–µ–Ω–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)";
            }

        } catch (e) {
            console.error(e);
            document.getElementById('ui-reason').innerText = "–û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞ GitHub Pages –∏–ª–∏ Live Server!";
            document.getElementById('ui-signal').style.color = 'var(--red)';
        }
    }

    // --- AI ANALYST ---
    async function askAI(price, change) {
        document.getElementById('ui-reason').innerText = "DeepSeek –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç...";
        
        // –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Ç–æ—á–µ–∫)
        const historyStr = STATE.prices.slice(-10).join(', ');

        const prompt = `
        Instrument: ${STATE.ticker} (USD/RUB Future).
        Current Price: ${price}. Daily Change: ${change}%.
        Recent history: [${historyStr}].
        
        Role: Swing Trader Bot.
        Task: Analyze trend. Return JSON:
        {"action": "BUY"|"SELL"|"HOLD", "reason": "Russian text max 6 words"}
        
        Logic:
        - If price is rising consistently -> BUY/HOLD.
        - If price is falling consistently -> SELL/HOLD.
        - Don't signal on noise.
        `;

        try {
            const req = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${STATE.apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "deepseek/deepseek-chat",
                    messages: [{"role": "user", "content": prompt}],
                    response_format: { "type": "json_object" }
                })
            });
            const res = await req.json();
            const ai = JSON.parse(res.choices[0].message.content);
            
            setSignal(ai.action, ai.reason);

        } catch (e) {
            simpleAlgo(price, change); // –§–æ–ª–±—ç–∫ –µ—Å–ª–∏ AI –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª
        }
    }

    // --- FALLBACK ALGO (–ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–∞) ---
    function simpleAlgo(price, change) {
        let action = "HOLD";
        let reason = "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥";
        let color = "#888";

        // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞ —Å–º–µ–Ω–µ –∑–Ω–∞–∫–∞ –¥–Ω—è
        if (change > 0.5) { action = "BUY ZONE"; color = "var(--green)"; }
        if (change < -0.5) { action = "SELL ZONE"; color = "var(--red)"; }

        setSignal(action, reason, color);
    }

    // --- UI UPDATES ---
    function setSignal(action, reason, forceColor) {
        const elSig = document.getElementById('ui-signal');
        const elCard = document.getElementById('signal-card');
        const elDot = document.getElementById('saver-dot');

        elSig.innerText = action;
        document.getElementById('ui-reason').innerText = reason;

        let color = forceColor || '#888';
        if (!forceColor) {
            if (action.includes('BUY')) color = 'var(--green)';
            if (action.includes('SELL')) color = 'var(--red)';
            if (action.includes('HOLD')) color = 'var(--blue)';
        }

        elSig.style.color = color;
        elCard.style.borderColor = color;
        elDot.style.background = color;
        elDot.style.boxShadow = `0 0 20px ${color}`;

        // –ó–≤—É–∫ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∏–≥–Ω–∞–ª–∞ (–∫—Ä–æ–º–µ HOLD)
        if (action !== STATE.lastSignal && !action.includes('HOLD')) {
            const audio = document.getElementById('snd-alert');
            audio.play().catch(()=>{});
            if(navigator.vibrate) navigator.vibrate(200);
        }
        STATE.lastSignal = action;
    }

    function updateUI(price, change) {
        const elPrice = document.getElementById('ui-price');
        elPrice.innerText = price.toLocaleString('ru-RU');
        
        const elChange = document.getElementById('ui-change');
        elChange.innerText = (change > 0 ? '+' : '') + change + '%';
        elChange.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';

        document.getElementById('saver-price').innerText = price;
    }

    function updateChart(price) {
        STATE.prices.push(price);
        if (STATE.prices.length > 50) STATE.prices.shift();
        
        chart.data.labels = new Array(STATE.prices.length).fill('');
        chart.data.datasets[0].data = STATE.prices;
        chart.update();
    }

    // --- UTILITIES ---
    function startTimer() {
        let t = 60;
        const el = document.getElementById('timer');
        clearInterval(window.tmr);
        window.tmr = setInterval(() => {
            el.innerText = t > 9 ? t : '0'+t;
            t--;
            if(t < 0) clearInterval(window.tmr);
        }, 1000);
    }

    function toggleSaver() {
        document.body.classList.toggle('saver-mode');
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞
        if ('wakeLock' in navigator && document.body.classList.contains('saver-mode')) {
            navigator.wakeLock.request('screen').catch(e => console.log('WakeLock error', e));
        }
    }

    function toggleSettings() {
        const el = document.getElementById('settings-modal');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
        document.getElementById('inp-key').value = STATE.apiKey;
    }

    function saveSettings() {
        STATE.apiKey = document.getElementById('inp-key').value;
        localStorage.setItem('trader_key', STATE.apiKey);
        toggleSettings();
        tick(); // –°—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º
    }

    // --- START ---
    setInterval(tick, STATE.interval);
    tick(); // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫

</script>
</body>
</html>
