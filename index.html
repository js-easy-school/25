<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Si-3.26 Direct PRO</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #141414;
            --text-main: #e0e0e0;
            --green: #00e676;
            --red: #ff1744;
            --blue: #2979ff;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        /* OLED SAVER */
        body.saver-mode > *:not(#saver-overlay) { opacity: 0; pointer-events: none; }
        #saver-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 9999; flex-direction: column; align-items: center; justify-content: center;
        }
        body.saver-mode #saver-overlay { display: flex; }

        .status-dot {
            width: 15px; height: 15px; border-radius: 50%;
            background: #333; box-shadow: 0 0 15px #333;
            animation: pulse 3s infinite;
        }
        @keyframes pulse { 0% {opacity: 0.3} 50% {opacity: 1} 100% {opacity: 0.3} }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 20px;
        }
        .ticker { font-size: 14px; color: #666; font-weight: bold; letter-spacing: 1px; }
        .price { font-size: 48px; font-weight: 700; line-height: 1; letter-spacing: -1px; }
        .change { font-size: 18px; font-weight: 500; margin-top: 5px; }

        /* SIGNAL CARD */
        .signal-card {
            background: var(--card-bg);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .sig-val { font-size: 36px; font-weight: 900; margin: 10px 0; letter-spacing: 1px; }
        .sig-reason { color: #888; font-size: 14px; min-height: 40px; }

        /* CHART AREA */
        .chart-container {
            flex-grow: 1;
            background: #0a0a0a;
            border-radius: 12px;
            position: relative;
            min-height: 200px;
            border: 1px solid #222;
        }

        /* BOTTOM CONTROLS */
        .controls {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .btn {
            flex: 1; padding: 15px; border: none; border-radius: 8px;
            background: #222; color: #fff; font-weight: 600; cursor: pointer;
        }
        .btn-oled { background: #311b92; }

        /* SETTINGS */
        #settings {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95); z-index: 100; padding: 30px;
        }
        input { width: 100%; padding: 15px; margin: 10px 0; background: #222; border: 1px solid #444; color: #fff; box-sizing: border-box;}
    </style>
</head>
<body>

    <div id="saver-overlay" onclick="toggleSaver()">
        <div class="status-dot" id="saver-dot"></div>
        <div id="saver-price" style="margin-top: 30px; color: #333; font-family: monospace;">---</div>
    </div>

    <div class="header">
        <div>
            <div class="ticker">Si-3.26 (SiH6)</div>
            <div class="price" id="ui-price">---</div>
            <div class="change" id="ui-change">0.00%</div>
        </div>
        <div style="text-align: right;">
            <div style="color: #444; font-size: 10px;">UPD</div>
            <div id="timer" style="color: #888; font-family: monospace; font-size: 18px;">--</div>
        </div>
    </div>

    <div class="signal-card" id="card">
        <div style="font-size: 10px; opacity: 0.5;">AI MONITOR</div>
        <div class="sig-val" id="ui-signal">WAIT</div>
        <div class="sig-reason" id="ui-reason">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∏—Ä–∂–µ...</div>
    </div>

    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>

    <div class="controls">
        <button class="btn btn-oled" onclick="toggleSaver()">üåô OLED Mode</button>
        <button class="btn" onclick="toggleSettings()">‚öôÔ∏è API Key</button>
    </div>

    <div id="settings">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <label style="color:#888; font-size:12px;">OpenRouter / DeepSeek Key</label>
        <input type="password" id="inp-key" placeholder="sk-or-v1-...">
        <button class="btn" style="background: var(--blue);" onclick="saveSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn" style="background: transparent; margin-top:10px;" onclick="toggleSettings()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <audio id="snd" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.m4a"></audio>

<script>
    // --- –ö–û–ù–§–ò–ì ---
    const STATE = {
        ticker: 'SiH6', // –ö–æ–¥ —Ñ—å—é—á–µ—Ä—Å–∞ –Ω–∞ –ú–∞—Ä—Ç 2026
        apiKey: localStorage.getItem('my_key') || '',
        interval: 60000, // 1 –º–∏–Ω—É—Ç–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è —Å–≤–µ—á–µ–π)
        prices: [],
        lastPrice: 0
    };

    // --- –ì–†–ê–§–ò–ö ---
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#2979ff',
                backgroundColor: 'rgba(41, 121, 255, 0.1)',
                borderWidth: 2,
                fill: true,
                pointRadius: 0,
                tension: 0.1
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { position: 'right', grid: { color: '#1a1a1a' } }
            },
            animation: false
        }
    });

    // --- –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---
    async function tick() {
        startTimer();

        // 1. –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ MOEX (–±–µ–∑ –ø—Ä–æ–∫—Å–∏)
        // boards/RFUD = –§—å—é—á–µ—Ä—Å—ã
        const url = `https://iss.moex.com/iss/engines/futures/markets/forts/boards/RFUD/securities/${STATE.ticker}.json?iss.meta=off&iss.only=marketdata&marketdata.columns=LAST,LASTCHANGEPRCNT&_=${Date.now()}`;

        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error('MOEX 404');
            const json = await res.json();
            
            // –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç (–ú–æ—Å–±–∏—Ä–∂–∞ –æ—Ç–¥–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã)
            const data = json.marketdata.data[0];
            if (!data) return; // –†—ã–Ω–æ–∫ –∑–∞–∫—Ä—ã—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞ —Ç–∏–∫–µ—Ä–∞

            const price = Number(data[0]); // LAST
            const change = Number(data[1]); // LASTCHANGEPRCNT

            updateUI(price, change);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
            if (price !== STATE.lastPrice) {
                STATE.prices.push(price);
                if (STATE.prices.length > 100) STATE.prices.shift();
                
                chart.data.labels = new Array(STATE.prices.length).fill('');
                chart.data.datasets[0].data = STATE.prices;
                chart.update();
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–ª—é—á, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º AI
                if (STATE.apiKey) {
                    askAI(price, change);
                } else {
                    simpleAlgo(price);
                }
                
                STATE.lastPrice = price;
            }

        } catch (e) {
            console.error(e);
            document.getElementById('ui-reason').innerText = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ MOEX. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
        }
    }

    // --- –õ–û–ì–ò–ö–ê –°–ò–ì–ù–ê–õ–û–í ---
    function simpleAlgo(price) {
        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç AI
        const diff = STATE.prices.length > 1 ? price - STATE.prices[STATE.prices.length - 2] : 0;
        let action = "HOLD";
        let color = "#888";
        
        if (diff > 20) { action = "BUY IMPULSE"; color = "var(--green)"; }
        if (diff < -20) { action = "SELL IMPULSE"; color = "var(--red)"; }
        
        setSignal(action, "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è AI)", color);
    }

    async function askAI(price, change) {
        document.getElementById('ui-reason').innerText = "–ê–Ω–∞–ª–∏–∑ DeepSeek...";
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç
        const prompt = `
        Ticker: ${STATE.ticker}. Price: ${price}. Change: ${change}%.
        History last 5 ticks: ${STATE.prices.slice(-5).join(', ')}.
        Role: Swing Trader.
        Task: JSON output {"action": "BUY"|"SELL"|"HOLD", "reason": "Russian, max 5 words", "risk": "Low/High"}.
        Strategy: Look for trend reversal or continuation.
        `;

        try {
            const req = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${STATE.apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "deepseek/deepseek-chat",
                    messages: [{role: "user", content: prompt}],
                    response_format: { type: "json_object" }
                })
            });
            const ans = await req.json();
            const result = JSON.parse(ans.choices[0].message.content);
            
            let color = "#fff";
            if (result.action === 'BUY') color = "var(--green)";
            if (result.action === 'SELL') color = "var(--red)";
            
            setSignal(result.action, result.reason, color);

        } catch (e) {
            console.error(e);
        }
    }

    function setSignal(act, reason, color) {
        document.getElementById('ui-signal').innerText = act;
        document.getElementById('ui-signal').style.color = color;
        document.getElementById('ui-reason').innerText = reason;
        document.getElementById('card').style.borderColor = color;
        
        // OLED Dot update
        const dot = document.getElementById('saver-dot');
        dot.style.background = color;
        dot.style.boxShadow = `0 0 20px ${color}`;

        // Sound if signal changed strictly
        if (act !== 'HOLD' && !document.body.classList.contains('muted')) {
            document.getElementById('snd').play().catch(()=>{});
        }
    }

    function updateUI(price, change) {
        document.getElementById('ui-price').innerText = price;
        document.getElementById('saver-price').innerText = price;
        
        const elCh = document.getElementById('ui-change');
        elCh.innerText = (change > 0 ? '+' : '') + change + '%';
        elCh.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
    }

    // --- –¢–ê–ô–ú–ï–† –ò –£–¢–ò–õ–ò–¢–´ ---
    function startTimer() {
        let t = 60;
        const el = document.getElementById('timer');
        clearInterval(window.timerInterval);
        window.timerInterval = setInterval(() => {
            el.innerText = t > 9 ? t : '0'+t;
            t--;
            if (t < 0) clearInterval(window.timerInterval);
        }, 1000);
    }

    function toggleSaver() {
        document.body.classList.toggle('saver-mode');
        // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ—Ä–∂–∞—Ç—å —ç–∫—Ä–∞–Ω –≤–∫–ª—é—á–µ–Ω–Ω—ã–º
        if ('wakeLock' in navigator && document.body.classList.contains('saver-mode')) {
            navigator.wakeLock.request('screen').catch(()=>{});
        }
    }

    function toggleSettings() {
        const el = document.getElementById('settings');
        el.style.display = el.style.display === 'block' ? 'none' : 'block';
        document.getElementById('inp-key').value = STATE.apiKey;
    }

    function saveSettings() {
        STATE.apiKey = document.getElementById('inp-key').value;
        localStorage.setItem('my_key', STATE.apiKey);
        toggleSettings();
        tick(); // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º
    }

    // –°—Ç–∞—Ä—Ç
    setInterval(tick, STATE.interval);
    tick();

</script>
</body>
</html>
